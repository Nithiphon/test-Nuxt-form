<template>
  <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏ß‡∏¢‡πÜ -->
  <div class="min-vh-auto bg-light py-5">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-12 col-md-6 col-lg-8">
          
          <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏° -->
          <div class="card shadow-lg border-0">
            <div class="card-header bg-dark text-white text-center py-4">
              <h1 class="mb-0 fs-3">üìù ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h1>
              <p class="mb-0 mt-2 opacity-75 small">(‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö)</p>
            </div>
            
            <div class="card-body p-4">
              <form @submit.prevent="submitForm">
                
                <!-- ‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• -->
                <div class="mb-3 fs-5 p-2">
                  <label class="form-label fw-semibold">
                    ‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• 
                    <span class="text-danger">*</span>
                  </label>
                  <input 
                    v-model="formData.fullName" 
                    type="text" 
                    class="form-control form-control-lg fs-6"
                    placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"
                    required
                  >
                </div>

                <!-- ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô -->
                <div class="mb-3 fs-5 p-2">
                  <label class="form-label fw-semibold">
                    ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô 
                    <span class="text-danger">*</span>
                  </label>
                  <input 
                    v-model="formData.nickname" 
                    type="text" 
                    class="form-control form-control-lg fs-6"
                    placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô"
                    required
                  >
                </div>

                <!-- ‡∏≠‡∏≤‡∏¢‡∏∏ -->
                <div class="mb-3 fs-5 p-2">
                  <label class="form-label fw-semibold">
                    ‡∏≠‡∏≤‡∏¢‡∏∏ 
                    <span class="text-danger">*</span>
                  </label>
                  <input 
                    v-model.number="formData.age" 
                    type="number" 
                    class="form-control form-control-lg fs-6"
                    placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏≤‡∏¢‡∏∏"
                    min="1"
                    max="100"
                    required
                  >
                </div>

                <!-- ‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Ç‡πà‡∏á -->
                <div class="row">
                <div class="mb-3 fs-5 ">
                  <label class="form-label fw-semibold">
                    ‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á 
                    <span class="text-danger">*</span>
                  </label>
                  <div class="bg-light text-dark p-3 rounded fs-6">
                    <div class="form-check mb-2">
                      <input 
                        v-model="formData.ageGroup" 
                        type="radio" 
                        class="form-check-input"
                        id="under18"
                        value="‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 18 ‡∏õ‡∏µ"
                        required
                      >
                      <label class="form-check-label" for="under18">
                        ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 18 ‡∏õ‡∏µ
                      </label>
                    </div>
                    <div class="form-check">
                      <input 
                        v-model="formData.ageGroup" 
                        type="radio" 
                        class="form-check-input"
                        id="over18"
                        value="‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 18 ‡∏õ‡∏µ"
                        required
                      >
                      <label class="form-check-label " for="over18">
                        ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 18 ‡∏õ‡∏µ
                      </label>
                    </div>
                  </div>
                </div>
                </div>
                <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà -->
                <div class="mb-4">
                  <label class="form-label fw-semibold">
                    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà 
                    <span class="text-danger">*</span>
                  </label>
                  <p class="text-muted small mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ô‡∏≤‡∏°‡πÉ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</p>
                  <select 
                    v-model="formData.location" 
                    class="form-select form-select-lg fs-6 fw-bold"
                    required
                  >
                    <option value="" disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà --</option>
                    <option value="‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ">üìç ‡πÄ‡∏ã‡πá‡∏ô‡∏ó‡∏£‡∏±‡∏•‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ</option>
                    <option value="‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç">üìç ‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç</option>
                    <option value="‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤">üìç ‡πÄ‡∏ã‡πá‡∏ô‡∏ó‡∏£‡∏±‡∏•‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤</option>
                  </select>
                </div>

                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° -->
                <div class="d-grid">
                  <button 
                    type="submit" 
                    class="btn btn-success btn-lg py-3"
                    :disabled="isSubmitting"
                  >
                    <span v-if="isSubmitting">
                      <span class="spinner-border spinner-border-sm me-2"></span>
                      ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...
                    </span>
                    <span v-else class="fw-bold">
                      Submit
                    </span>
                  </button>
                </div>
              </form>

              <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -->
              <div 
                v-if="successMessage" 
                class="alert alert-success alert-dismissible fade show mt-4 mb-0"
                role="alert"
              >
                <div class="d-flex align-items-center">
                  <div class="fs-4 me-2">‚úÖ</div>
                  <div class="flex-grow-1">
                    <strong>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</strong> {{ successMessage }}
                  </div>
                </div>
                <button 
                  type="button" 
                  class="btn-close" 
                  @click="successMessage = ''"
                ></button>
              </div>

              <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î -->
              <div 
                v-if="errorMessage" 
                class="alert alert-danger alert-dismissible fade show mt-4 mb-0"
                role="alert"
              >
                <div class="d-flex align-items-center">
                  <div class="fs-4 me-2">‚ùå</div>
                  <div class="flex-grow-1">
                    <strong>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!</strong> {{ errorMessage }}
                  </div>
                </div>
                <button 
                  type="button" 
                  class="btn-close" 
                  @click="errorMessage = ''"
                ></button>
              </div>
            </div>

            <!-- Footer ‡∏Å‡∏≤‡∏£‡πå‡∏î -->
            <div class="card-footer bg-light text-center text-muted py-3">
              <small>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</small>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
// ‡πÇ‡∏´‡∏•‡∏î Bootstrap
useHead({
  link: [
    {
      rel: 'stylesheet',
      href: 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css'
    }
  ],
  script: [
    {
      src: 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js'
    }
  ]
})

import { collection, addDoc, getDocs, deleteDoc, doc, query, orderBy } from 'firebase/firestore'

const { $db } = useNuxtApp()

// ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°
const formData = ref({
  fullName: '',
  nickname: '',
  age: null,
  ageGroup: '',
  location: ''
})

const isSubmitting = ref(false)
const loading = ref(false)
const successMessage = ref('')
const errorMessage = ref('')
const registrants = ref([])

// ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
const clearMessages = () => {
  successMessage.value = ''
  errorMessage.value = ''
}

// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
const fetchRegistrants = async () => {
  loading.value = true
  try {
    const q = query(collection($db, 'registrations'), orderBy('timestamp', 'desc'))
    const querySnapshot = await getDocs(q)
    
    registrants.value = []
    querySnapshot.forEach((docSnap) => {
      registrants.value.push({
        id: docSnap.id,
        ...docSnap.data()
      })
    })
  } catch (error) {
    console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error)
  } finally {
    loading.value = false
  }
}

// ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
const submitForm = async () => {
  clearMessages()
  isSubmitting.value = true

  try {
    await addDoc(collection($db, 'registrations'), {
      ...formData.value,
      timestamp: Date.now()
    })

    successMessage.value = `‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∏‡∏ì ${formData.value.nickname}`
    
    // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
    formData.value = {
      fullName: '',
      nickname: '',
      age: null,
      ageGroup: '',
      location: ''
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
    await fetchRegistrants()

    // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    setTimeout(() => {
      successMessage.value = ''
    }, 3000)

  } catch (error) {
    console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error)
    errorMessage.value = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
  } finally {
    isSubmitting.value = false
  }
}

// ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
const deleteRegistrant = async (id) => {
  if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return

  try {
    await deleteDoc(doc($db, 'registrations', id))
    successMessage.value = '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'
    await fetchRegistrants()
    
    setTimeout(() => {
      successMessage.value = ''
    }, 2000)
  } catch (error) {
    console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error)
    errorMessage.value = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'
  }
}

// ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
const formatDate = (timestamp) => {
  const date = new Date(timestamp)
  return date.toLocaleDateString('th-TH', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  })
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
onMounted(() => {
  fetchRegistrants()
})
</script>